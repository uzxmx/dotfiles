#!/usr/bin/env bash

DOTFILES_PARENT_DIR="$HOME/tmp"
DOTFILES_DIR="$DOTFILES_PARENT_DIR/dotfiles"

mkdir -p "$DOTFILES_PARENT_DIR"

export http_proxy=http://localhost:8123
export HTTP_PROXY=$http_proxy
export https_proxy=$http_proxy
export HTTPS_PROXY=$http_proxy

if ! type -p git &>/dev/null; then
  echo "You must have git installed."
  exit 1
fi

if [ -d "$DOTFILES_DIR" ]; then
  cd "$DOTFILES_DIR"
  git pull
else
  git clone --depth 1 https://github.com/uzxmx/dotfiles.git "$DOTFILES_DIR"
  cd "$DOTFILES_DIR"
fi

alias_cmd="alias non_intrusive_shell=\"$DOTFILES_DIR/scripts/misc/non_intrusive_shell\""

if ! grep "$alias_cmd" ~/.bashrc &>/dev/null; then
  echo "$alias_cmd" >>~/.bashrc
fi

"$DOTFILES_DIR/scripts/misc/non_intrusive_shell" -s <<'EOF'
  # The shell may not be interactive and '.zshrc' won't get loaded. So we source
  # it manually.
  source $DOTFILES_TARGET_DIR/.zshrc

  $DOTFILES_DIR/scripts/install/fzf
  $DOTFILES_DIR/scripts/install/fd
  $DOTFILES_DIR/scripts/install/rg
  $DOTFILES_DIR/scripts/install/nvim --do-all-steps
  $DOTFILES_DIR/scripts/install/tmux --install-plugins
EOF
